<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<title>Pixel Fishing EU</title>

<!-- PWA / iPhone app-like -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0b1320">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<link rel="apple-touch-icon" href="icon-192.png">

<style>
  body{margin:0;background:#0b1320;color:#eaf2ff;font-family:monospace;display:flex;justify-content:center}
  .wrap{width:min(440px,96vw);padding:10px}
  canvas{width:100%;height:auto;background:#08101a;border:1px solid #223;border-radius:12px;display:block;touch-action:none}
  .hud{display:flex;gap:8px;flex-wrap:wrap;align-items:center;justify-content:space-between;margin:6px 0 8px}
  .pill{background:#111a28;border:1px solid #233;padding:6px 10px;border-radius:999px;font-size:12px}
  .row{display:flex;gap:8px;margin-top:8px}
  button{flex:1;padding:10px;border-radius:12px;border:1px solid #334;background:#132033;color:#eaf2ff;font-size:15px}
  button:active{transform:scale(.99)}
  button:disabled{opacity:.6}
  .log{margin-top:8px;min-height:68px;opacity:.95;font-size:13px}
  .hint{opacity:.75;font-size:12px;margin-top:6px;text-align:center}

  /* Panels */
  .panel{
    display:none; position:fixed; left:0; top:0; right:0; bottom:0;
    background:rgba(0,0,0,.6); align-items:center; justify-content:center; padding:14px;
  }
  .card{
    width:min(460px, 96vw); max-height:80vh; overflow:auto;
    background:#0f1b2a; border:1px solid #2a3a55; border-radius:14px; padding:12px;
  }
  .card h3{margin:0 0 8px 0}
  .card .x{float:right}
  .list{display:flex;flex-direction:column;gap:8px}
  .item{background:#0c1624;border:1px solid #22344e;border-radius:12px;padding:10px;font-size:13px}
  .item b{font-size:14px}
  .small{opacity:.85;font-size:12px}
  .bar{
    height:10px; background:#16263c; border:1px solid #2a3a55; border-radius:999px; overflow:hidden;
  }
  .bar > div{height:100%; width:0%;}
  .tag{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a3a55;margin-left:6px;font-size:12px;opacity:.9}
</style>
</head>

<body>
<div class="wrap">
  <div class="hud">
    <div class="pill">ğŸ’° <b id="money">0</b> coins</div>
    <div class="pill">ğŸ£ Status: <b id="state">ready</b></div>
    <div class="pill">ğŸ’ Keepnet: <b id="netKg">0.00</b>/<b id="netCap">15.00</b> kg</div>
  </div>

  <canvas id="c" width="440" height="270"></canvas>

  <div class="row">
    <button id="castBtn">ğŸ¯ Cast</button>
    <button id="reelBtn">ğŸ§² Reel / Hook</button>
  </div>
  <div class="row">
    <button id="invBtn">ğŸ’ Inventory</button>
    <button id="shopBtn">ğŸ›’ Shop</button>
    <button id="dayBtn">ğŸŒ™ Night</button>
  </div>

  <div class="log" id="log"></div>
  <div class="hint">
    Tap canvas: 1 tap = Cast Â· Double tap = Reel/Hook Â· During Fight: hold the Reel button (watch tension).
  </div>
</div>

<!-- Inventory Panel -->
<div class="panel" id="invPanel">
  <div class="card">
    <button class="x" id="invClose">Close</button>
    <h3>ğŸ’ Keepnet (stored fish)</h3>
    <div class="small">You can sell anytime. If the keepnet is full, upgrade it in the Shop.</div>

    <div style="margin:10px 0">
      <div class="bar"><div id="netBar"></div></div>
      <div class="small" style="margin-top:6px">Total: <b id="netTotalTxt">0.00</b> kg / <b id="netCapTxt">15.00</b> kg</div>
    </div>

    <div class="row">
      <button id="sellAllBtn">ğŸ’¸ Sell all</button>
      <button id="releaseAllBtn">ğŸ«§ Release all</button>
    </div>

    <div class="list" id="invList" style="margin-top:10px"></div>
  </div>
</div>

<!-- Shop Panel -->
<div class="panel" id="shopPanel">
  <div class="card">
    <button class="x" id="shopClose">Close</button>
    <h3>ğŸ›’ Shop</h3>
    <div class="small">Gear affects bite speed, big fish chance, and line snapping. Upgrade keepnet to store larger hauls.</div>

    <div class="item" style="margin-top:10px">
      <b>Equipped</b>
      <div class="small" id="equippedTxt"></div>
    </div>

    <h3 style="margin-top:12px">ğŸ’ Keepnet upgrades</h3>
    <div class="list" id="netUpgradeList"></div>

    <h3 style="margin-top:12px">ğŸ£ Rods</h3>
    <div class="list" id="rodList"></div>

    <h3 style="margin-top:12px">ğŸ§µ Lines</h3>
    <div class="list" id="lineList"></div>

    <h3 style="margin-top:12px">ğŸª± Baits</h3>
    <div class="list" id="baitList"></div>
  </div>
</div>

<script>
(() => {
  const canvas = document.getElementById("c");
  const ctx = canvas.getContext("2d");

  const moneyEl = document.getElementById("money");
  const stateEl = document.getElementById("state");
  const logEl = document.getElementById("log");
  const netKgEl = document.getElementById("netKg");
  const netCapEl = document.getElementById("netCap");

  const castBtn = document.getElementById("castBtn");
  const reelBtn = document.getElementById("reelBtn");
  const invBtn = document.getElementById("invBtn");
  const shopBtn = document.getElementById("shopBtn");
  const dayBtn = document.getElementById("dayBtn");

  const invPanel = document.getElementById("invPanel");
  const invClose = document.getElementById("invClose");
  const invList = document.getElementById("invList");
  const sellAllBtn = document.getElementById("sellAllBtn");
  const releaseAllBtn = document.getElementById("releaseAllBtn");
  const netBar = document.getElementById("netBar");
  const netTotalTxt = document.getElementById("netTotalTxt");
  const netCapTxt = document.getElementById("netCapTxt");

  const shopPanel = document.getElementById("shopPanel");
  const shopClose = document.getElementById("shopClose");
  const equippedTxt = document.getElementById("equippedTxt");
  const rodList = document.getElementById("rodList");
  const lineList = document.getElementById("lineList");
  const baitList = document.getElementById("baitList");
  const netUpgradeList = document.getElementById("netUpgradeList");

  // ---------- Helpers ----------
  const W = canvas.width, H = canvas.height;
  const shoreY = 92;
  const waterY = shoreY + 10;

  const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
  const fmt2 = (x) => Number(x).toFixed(2);
  const rand = (min, max) => min + Math.random()*(max-min);

  const rarColor = (rar) => ({
    "common":"#eaf2ff",
    "uncommon":"#7CFF6B",
    "rare":"#5aa9ff",
    "epic":"#b16cff",
    "legendary":"#ffcc33"
  }[rar] || "#eaf2ff");

  function log(html){ logEl.innerHTML = html; }

  function setState(s){
    state = s;
    stateEl.textContent = ({
      ready:"ready",
      casting:"casting...",
      waiting:"waiting...",
      bite:"BITE!",
      fight:"FIGHT!",
      miss:"missed",
      snapped:"line snapped"
    }[s] || s);
  }

  // ---------- Save helpers ----------
  function loadNum(k, d){ return Number(localStorage.getItem(k) ?? d); }
  function saveNum(k, v){ localStorage.setItem(k, String(v)); }

  // ---------- Economy / inventory ----------
  let money = loadNum("pf_money", 0);

  const keepnet = []; // {name, rarity, kg, value, trophy}
  let keepnetCapKg = loadNum("pf_netcap", 15.0);

  function keepnetTotalKg(){
    return keepnet.reduce((s,f)=>s+f.kg,0);
  }

  function updateHud(){
    moneyEl.textContent = money;

    const total = keepnetTotalKg();
    netKgEl.textContent = fmt2(total);
    netCapEl.textContent = fmt2(keepnetCapKg);

    const pct = clamp((total/keepnetCapKg)*100, 0, 100);
    netBar.style.width = pct + "%";
    netBar.style.background = pct < 80 ? "#2ecc71" : (pct < 100 ? "#ffcc33" : "#ff4d6d");
    netTotalTxt.textContent = fmt2(total);
    netCapTxt.textContent = fmt2(keepnetCapKg);
  }

  function addToKeepnet(fish){
    const total = keepnetTotalKg();
    if(total + fish.kg > keepnetCapKg + 1e-9){
      log(`ğŸ’ Keepnet full! You hooked <b style="color:${rarColor(fish.rarity)}">${fish.name}</b> (${fmt2(fish.kg)} kg) but it <b>doesn't fit</b>.<br>
           Upgrade your keepnet in the Shop or release something in Inventory.`);
      return false;
    }
    keepnet.push(fish);
    return true;
  }

  function renderInventory(){
    invList.innerHTML = "";
    if(keepnet.length === 0){
      invList.innerHTML = `<div class="item">No fish stored yet.</div>`;
      updateHud();
      return;
    }

    keepnet.forEach((f, idx) => {
      const el = document.createElement("div");
      el.className = "item";
      el.innerHTML = `
        <b style="color:${rarColor(f.rarity)}">${f.name}</b>
        <span class="tag" style="color:${rarColor(f.rarity)}">${f.rarity}</span>
        ${f.trophy ? `<span class="tag" style="color:#ffcc33">TROPHY</span>` : ``}
        <br>
        âš–ï¸ <b>${fmt2(f.kg)}</b> kg Â· ğŸ’° <b>${f.value}</b> coins
        <div class="row" style="margin-top:8px">
          <button data-sell="${idx}">Sell</button>
          <button data-rel="${idx}">Release</button>
        </div>
      `;
      invList.appendChild(el);
    });

    invList.querySelectorAll("button[data-sell]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-sell"));
        const f = keepnet[i];
        money += f.value;
        keepnet.splice(i,1);
        saveNum("pf_money", money);
        renderInventory();
        updateHud();
      });
    });

    invList.querySelectorAll("button[data-rel]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const i = Number(btn.getAttribute("data-rel"));
        keepnet.splice(i,1);
        renderInventory();
        updateHud();
      });
    });

    updateHud();
  }

  sellAllBtn.addEventListener("click", () => {
    const sum = keepnet.reduce((s,f)=>s+f.value,0);
    money += sum;
    keepnet.length = 0;
    saveNum("pf_money", money);
    renderInventory();
    updateHud();
    log(`ğŸ’¸ Sold everything in keepnet: +<b>${sum}</b> coins.`);
  });

  releaseAllBtn.addEventListener("click", () => {
    keepnet.length = 0;
    renderInventory();
    updateHud();
    log(`ğŸ«§ Released all fish.`);
  });

  // ---------- Equipment / shop ----------
  const rods = [
    {id:"rod_basic", name:"Starter Rod",    price:0,   biteBonus:0.00, bigBonus:0.00},
    {id:"rod_lake",  name:"Lake Rod",       price:250, biteBonus:0.08, bigBonus:0.06},
    {id:"rod_pro",   name:"Pro Rod",        price:800, biteBonus:0.15, bigBonus:0.12},
  ];
  const lines = [
    {id:"line_4",  name:"Line 4 kg",  price:0,   strengthKg:4},
    {id:"line_10", name:"Line 10 kg", price:220, strengthKg:10},
    {id:"line_20", name:"Line 20 kg", price:650, strengthKg:20},
  ];
  const baits = [
    {id:"bait_worm",   name:"Worm",        price:0,   bias:"peaceful"},
    {id:"bait_corn",   name:"Corn",        price:60,  bias:"carp"},
    {id:"bait_minnow", name:"Live Minnow", price:140, bias:"predator"},
  ];

  // Keepnet upgrades
  // next capacity upgrades cost coins; saved by updating pf_netcap
  const keepnetUpgrades = [
    {cap: 15,  price: 0,    label:"15 kg (Starter)"},
    {cap: 25,  price: 220,  label:"25 kg"},
    {cap: 40,  price: 550,  label:"40 kg"},
    {cap: 60,  price: 950,  label:"60 kg"},
    {cap: 85,  price: 1400, label:"85 kg"},
  ];

  let equippedRodId  = localStorage.getItem("pf_rod")  || "rod_basic";
  let equippedLineId = localStorage.getItem("pf_line") || "line_4";
  let equippedBaitId = localStorage.getItem("pf_bait") || "bait_worm";
  let isNight = (localStorage.getItem("pf_night") === "1");

  function getRod(){ return rods.find(r=>r.id===equippedRodId) || rods[0]; }
  function getLine(){ return lines.find(l=>l.id===equippedLineId) || lines[0]; }
  function getBait(){ return baits.find(b=>b.id===equippedBaitId) || baits[0]; }

  function ownedKey(id){ return "pf_owned_" + id; }
  function isOwned(id){ return localStorage.getItem(ownedKey(id)) === "1" || priceOf(id) === 0; }
  function setOwned(id){ localStorage.setItem(ownedKey(id), "1"); }

  function priceOf(id){
    const all = [...rods, ...lines, ...baits];
    const it = all.find(x=>x.id===id);
    return it ? it.price : 0;
  }

  function equip(id){
    if(id.startsWith("rod_"))  equippedRodId = id, localStorage.setItem("pf_rod", id);
    if(id.startsWith("line_")) equippedLineId = id, localStorage.setItem("pf_line", id);
    if(id.startsWith("bait_")) equippedBaitId = id, localStorage.setItem("pf_bait", id);
  }

  function buy(id){
    const p = priceOf(id);
    if(isOwned(id)) return true;
    if(money < p){
      log(`âŒ Not enough coins. You need <b>${p}</b>.`);
      return false;
    }
    money -= p;
    saveNum("pf_money", money);
    setOwned(id);
    return true;
  }

  function buyKeepnetUpgrade(newCap, price){
    if(newCap <= keepnetCapKg) return;

    if(money < price){
      log(`âŒ Not enough coins for keepnet upgrade. You need <b>${price}</b>.`);
      return;
    }
    money -= price;
    keepnetCapKg = newCap;
    saveNum("pf_money", money);
    saveNum("pf_netcap", keepnetCapKg);

    updateHud();
    renderShop();
    log(`âœ… Keepnet upgraded to <b>${newCap} kg</b> capacity.`);
  }

  function renderShop(){
    const rod = getRod(), line = getLine(), bait = getBait();

    equippedTxt.innerHTML = `
      ğŸ£ <b>${rod.name}</b> (bite +${Math.round(rod.biteBonus*100)}%, big fish +${Math.round(rod.bigBonus*100)}%)<br>
      ğŸ§µ <b>${line.name}</b> (strength <b>${line.strengthKg} kg</b>)<br>
      ğŸª± <b>${bait.name}</b><br>
      ğŸ’ Keepnet: <b>${fmt2(keepnetCapKg)} kg</b>
    `;

    // Keepnet upgrades
    const currentCap = keepnetCapKg;
    netUpgradeList.innerHTML = keepnetUpgrades.map(u => {
      const owned = (u.cap <= currentCap);
      const canBuy = (!owned && u.cap > currentCap);
      const btnText = owned ? "Owned" : `Buy (${u.price} coins)`;
      return `
        <div class="item">
          <b>${u.label}</b>
          <div class="small">Capacity: <b>${u.cap} kg</b></div>
          <div class="row" style="margin-top:8px">
            <button data-netcap="${u.cap}" data-netprice="${u.price}" ${owned ? "disabled" : ""}>${btnText}</button>
          </div>
        </div>
      `;
    }).join("");

    netUpgradeList.querySelectorAll("button[data-netcap]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const cap = Number(btn.getAttribute("data-netcap"));
        const price = Number(btn.getAttribute("data-netprice"));
        buyKeepnetUpgrade(cap, price);
      });
    });

    function itemHtml(obj, extra){
      const owned = isOwned(obj.id);
      const eq = (obj.id===equippedRodId || obj.id===equippedLineId || obj.id===equippedBaitId);
      const btnText = eq ? "Equipped" : (owned ? "Equip" : `Buy (${obj.price} coins)`);
      return `
        <div class="item">
          <b>${obj.name}</b>
          <div class="small">${extra}</div>
          <div class="row" style="margin-top:8px">
            <button data-id="${obj.id}" ${eq ? "disabled" : ""}>${btnText}</button>
          </div>
        </div>
      `;
    }

    rodList.innerHTML = rods.map(r => itemHtml(r, `Bite bonus: ${Math.round(r.biteBonus*100)}% Â· Big fish: ${Math.round(r.bigBonus*100)}%`)).join("");
    lineList.innerHTML = lines.map(l => itemHtml(l, `Strength: <b>${l.strengthKg} kg</b> (big fish can snap weak line)`)).join("");
    baitList.innerHTML = baits.map(b => itemHtml(b, `Attracts: ${
      b.bias==="peaceful" ? "peaceful fish (bream/crucian)" :
      b.bias==="carp" ? "carp more often" : "predators (zander/pike/catfish)"
    }`)).join("");

    shopPanel.querySelectorAll("button[data-id]").forEach(btn=>{
      btn.addEventListener("click", () => {
        const id = btn.getAttribute("data-id");
        if(isOwned(id)){
          equip(id);
          renderShop();
          log(`âœ… Equipped: <b>${(rods.concat(lines,baits).find(x=>x.id===id)?.name)||id}</b>.`);
          updateHud();
        }else{
          if(buy(id)){
            equip(id);
            renderShop();
            log(`ğŸ›’ Bought & equipped: <b>${(rods.concat(lines,baits).find(x=>x.id===id)?.name)||id}</b>.`);
            updateHud();
          }
        }
      });
    });

    updateHud();
  }

  // Starter items owned
  rods.forEach(r=>{ if(r.price===0) setOwned(r.id); });
  lines.forEach(l=>{ if(l.price===0) setOwned(l.id); });
  baits.forEach(b=>{ if(b.price===0) setOwned(b.id); });

  // ---------- Fish system (real Europe, simplified) ----------
  const fishDB = [
    {name:"Crucian Carp", min:0.30, max:1.50, priceKg: 8,  group:"peaceful"},
    {name:"Bream",        min:0.50, max:3.00, priceKg:10,  group:"peaceful"},
    {name:"Chub",         min:0.40, max:2.20, priceKg:11,  group:"peaceful"},
    {name:"Common Carp",  min:1.00, max:20.0, priceKg:12,  group:"carp"},
    {name:"Trout",        min:0.50, max:6.00, priceKg:22,  group:"river"},
    {name:"Zander",       min:1.00, max:15.0, priceKg:20,  group:"predator"},
    {name:"Catfish",      min:5.00, max:80.0, priceKg:30,  group:"predator"},
    {name:"Pike",         min:1.50, max:18.0, priceKg:21,  group:"predator"},
  ];

  function rarityRoll(){
    let r = Math.random()*100;
    const nightBoost = isNight ? 1.10 : 1.0;

    // Approx: legendary 0.3, epic 1.7, rare 8, uncommon 18, rest common
    if(r < 0.30*nightBoost) return "legendary";
    if(r < (0.30*nightBoost) + 1.70*nightBoost) return "epic";
    if(r < (0.30+1.70)*nightBoost + 8.0*nightBoost) return "rare";
    if(r < (0.30+1.70+8.0)*nightBoost + 18.0) return "uncommon";
    return "common";
  }

  function pickSpecies(){
    const bait = getBait();
    const rod = getRod();

    const weights = fishDB.map(f => {
      let w = 1;

      // bait bias
      if(bait.bias==="peaceful") w *= (f.group==="peaceful" ? 2.2 : (f.group==="predator" ? 0.6 : 1));
      if(bait.bias==="carp")     w *= (f.group==="carp" ? 2.4 : (f.group==="peaceful" ? 1.2 : 0.7));
      if(bait.bias==="predator") w *= (f.group==="predator" ? 2.6 : 0.6);

      // night bias
      if(isNight && f.group==="predator") w *= 1.2;
      if(isNight && f.name==="Catfish") w *= 1.6;

      // rod big bonus slightly biases toward bigger-max species
      w *= (1 + rod.bigBonus * (f.max / 20));

      return w;
    });

    const sum = weights.reduce((a,b)=>a+b,0);
    let r = Math.random()*sum, acc=0;
    for(let i=0;i<fishDB.length;i++){
      acc += weights[i];
      if(r <= acc) return fishDB[i];
    }
    return fishDB[0];
  }

  function generateFish(){
    const sp = pickSpecies();
    const rarity = rarityRoll();
    const rod = getRod();

    let w = rand(sp.min, sp.max);

    const rarMul = { common:1.00, uncommon:1.10, rare:1.25, epic:1.55, legendary:1.90 }[rarity] || 1;
    const bigPush = 1 + rod.bigBonus * 0.9;

    w = Math.min(sp.max, w * rarMul * bigPush);

    const trophy = (w >= sp.max * 0.88);

    const baseVal = w * sp.priceKg;
    const rarValMul = { common:1.0, uncommon:1.15, rare:1.4, epic:2.0, legendary:3.0 }[rarity] || 1.0;
    const value = Math.max(1, Math.floor(baseVal * rarValMul));

    return { name: sp.name, rarity, kg: w, value, trophy };
  }

  // ---------- Fishing scene ----------
  const fisher = { x: 86, y: shoreY-18 };
  const bobber = { x: fisher.x+22, y: fisher.y+14, vx:0, vy:0, inWater:false };

  // States: ready -> casting -> waiting -> bite -> fight -> (snapped/miss)
  let state = "ready";
  let biteAt = 0, missAt = 0;

  // Fight minigame
  let hookedFish = null;
  let tension = 0;
  let fishPull = 0;
  let holdingReel = false;
  let fightEndAt = 0;
  let fightDuration = 1;

  function startCasting(){
    if(state !== "ready") return;

    setState("casting");
    log("ğŸ¯ You cast the line...");

    const targetX = 260 + Math.random()*150;
    const targetY = waterY + 65 + Math.random()*80;

    bobber.x = fisher.x + 22;
    bobber.y = fisher.y + 14;
    bobber.vx = (targetX - bobber.x)/18;
    bobber.vy = (targetY - bobber.y)/18;
    bobber.inWater = false;

    const now = performance.now();
    const rod = getRod();
    const baseWait = 900 + Math.random()*1600;
    const speedFactor = 1 - (rod.biteBonus + (isNight ? 0.04 : 0));
    biteAt = now + baseWait * clamp(speedFactor, 0.75, 1.05);
    missAt = biteAt + 1600;
  }

  function startFight(fish){
    hookedFish = fish;
    setState("fight");
    tension = 0.15;
    fishPull = 0;
    holdingReel = false;

    fightDuration = (1100 + fish.kg*30);
    fightEndAt = performance.now() + fightDuration;

    log(`ğŸ£ Hooked! <b style="color:${rarColor(fish.rarity)}">${fish.name}</b> (${fmt2(fish.kg)} kg, ${fish.rarity}${fish.trophy ? " Â· TROPHY" : ""})<br>
         Hold <b>Reel</b> to pull in, but keep tension under control.`);
  }

  function onReelTap(){
    if(state==="casting") return;

    if(state==="waiting"){
      log("ğŸ«§ Reeled too early... nothing.");
      setState("ready");
      return;
    }

    if(state==="bite"){
      const fish = generateFish();
      startFight(fish);
      return;
    }

    if(state==="miss" || state==="snapped"){
      log("ğŸ£ Try again.");
      setState("ready");
      return;
    }
  }

  // Hold-to-reel
  reelBtn.addEventListener("pointerdown", (e) => { holdingReel = true; e.preventDefault(); });
  reelBtn.addEventListener("pointerup",   (e) => { holdingReel = false; e.preventDefault(); });
  reelBtn.addEventListener("pointercancel",(e)=>{ holdingReel = false; e.preventDefault(); });
  reelBtn.addEventListener("click", onReelTap);

  castBtn.addEventListener("click", startCasting);

  // Canvas tap / double tap
  let lastTap = 0;
  canvas.addEventListener("pointerdown", () => {
    const now = Date.now();
    if(now - lastTap < 300) onReelTap();
    else startCasting();
    lastTap = now;
  });

  // Panels
  invBtn.addEventListener("click", () => { invPanel.style.display="flex"; renderInventory(); });
  invClose.addEventListener("click", () => { invPanel.style.display="none"; });
  shopBtn.addEventListener("click", () => { shopPanel.style.display="flex"; renderShop(); });
  shopClose.addEventListener("click", () => { shopPanel.style.display="none"; });

  // Day / Night
  function updateDayBtn(){
    dayBtn.textContent = isNight ? "â˜€ï¸ Day" : "ğŸŒ™ Night";
  }
  dayBtn.addEventListener("click", () => {
    isNight = !isNight;
    localStorage.setItem("pf_night", isNight ? "1":"0");
    updateDayBtn();
    log(isNight ? "ğŸŒ™ Night time. Predators get more active." : "â˜€ï¸ Day time. Common fish are more consistent.");
  });

  // iOS: prevent double-tap zoom
  let lastTouchEnd = 0;
  document.addEventListener("touchend", (e) => {
    const now = Date.now();
    if(now - lastTouchEnd <= 300) e.preventDefault();
    lastTouchEnd = now;
  }, { passive:false });

  // ---------- Drawing ----------
  function drawPixelRect(x,y,w,h,color){
    ctx.fillStyle = color;
    ctx.fillRect(Math.round(x), Math.round(y), Math.round(w), Math.round(h));
  }

  function drawFightHud(){
    const line = getLine();

    const x = 12, y = 12, w = W-24, h = 14;

    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.fillRect(x-4, y-6, w+8, 42);

    ctx.fillStyle = "#eaf2ff";
    ctx.font = "12px monospace";
    ctx.fillText(`Tension (line ${line.strengthKg}kg)`, x, y-1);

    ctx.fillStyle = "#16263c";
    ctx.fillRect(x, y+6, w, h);
    ctx.strokeStyle = "#2a3a55";
    ctx.strokeRect(x, y+6, w, h);

    const pct = clamp(tension, 0, 1.1);
    const fillW = (pct/1.0) * w;

    let col = "#2ecc71";
    if(pct > 0.75) col = "#ffcc33";
    if(pct > 0.95) col = "#ff4d6d";

    ctx.fillStyle = col;
    ctx.fillRect(x, y+6, Math.min(fillW, w), h);

    const prog = clamp(1 - (fightEndAt - performance.now()) / fightDuration, 0, 1);
    ctx.fillStyle = "#eaf2ff";
    ctx.fillText(`Progress: ${Math.round(prog*100)}%`, x, y+36);
  }

  function drawScene(t){
    // sky
    drawPixelRect(0,0,W,H, isNight ? "#061022" : "#08101a");
    // far mountains
    drawPixelRect(0,32,W,60, isNight ? "#07152c" : "#0d1b2a");

    // stars
    if(isNight){
      ctx.fillStyle = "rgba(255,255,255,0.55)";
      for(let i=0;i<35;i++){
        const sx = (i*73 + 19) % W;
        const sy = (i*29 + 11) % 70;
        ctx.fillRect(sx, sy, 1, 1);
      }
    }

    // shore
    drawPixelRect(0,shoreY-18,W,18, isNight ? "#24211d" : "#2d2a24");
    drawPixelRect(0,shoreY-10,W,10, isNight ? "#2f2a24" : "#3a342d");

    // water
    drawPixelRect(0,waterY,W,H-waterY, isNight ? "#06747a" : "#0a9396");

    // waves
    for(let i=0;i<10;i++){
      const y = waterY + 10 + i*14 + (Math.sin(t/700 + i)*2);
      drawPixelRect(0,y,W,2,"rgba(148,210,189,0.30)");
    }

    // fisherman sprite
    drawPixelRect(fisher.x, fisher.y, 8, 14, "#c27c5a");
    drawPixelRect(fisher.x+2, fisher.y-6, 6, 6, "#f1c27d");
    drawPixelRect(fisher.x+1, fisher.y-8, 8, 3, "#223");
    drawPixelRect(fisher.x-2, fisher.y+10, 5, 8, "#111");
    drawPixelRect(fisher.x+5, fisher.y+10, 5, 8, "#111");

    // rod
    ctx.strokeStyle = "#c9a227";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(fisher.x+7, fisher.y+3);
    ctx.lineTo(fisher.x+44, fisher.y-12);
    ctx.stroke();

    // line
    ctx.strokeStyle = "rgba(255,255,255,0.85)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(fisher.x+44, fisher.y-12);
    ctx.lineTo(bobber.x, bobber.y);
    ctx.stroke();

    // bobber
    drawPixelRect(bobber.x-3, bobber.y-3, 6, 6, "#ff4d6d");
    drawPixelRect(bobber.x-2, bobber.y-6, 4, 3, "#fff");

    // bite overlay
    if(state === "bite"){
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.fillRect(0,0,W,H);
      ctx.fillStyle = "#ffcc33";
      ctx.font = "bold 26px monospace";
      ctx.textAlign = "center";
      ctx.fillText("BITE! Double tap / Reel to hook!", W/2, H/2);
      ctx.textAlign = "start";
    }

    // fight overlay
    if(state === "fight" && hookedFish){
      drawFightHud();

      ctx.fillStyle = "rgba(0,0,0,0.35)";
      ctx.fillRect(12, H-44, W-24, 32);
      ctx.fillStyle = rarColor(hookedFish.rarity);
      ctx.font = "12px monospace";
      ctx.fillText(`Fish: ${hookedFish.name} Â· ${fmt2(hookedFish.kg)} kg Â· ${hookedFish.rarity}${hookedFish.trophy ? " Â· TROPHY" : ""}`, 18, H-24);
      ctx.fillStyle = "#eaf2ff";
      ctx.fillText(holdingReel ? "Reeling..." : "Hold Reel to pull", 18, H-10);
    }
  }

  // ---------- Update loop ----------
  function update(t){
    if(state === "casting"){
      bobber.x += bobber.vx;
      bobber.y += bobber.vy;
      if(bobber.y >= waterY + 52){
        bobber.y = waterY + 52;
        bobber.vx = 0; bobber.vy = 0;
        bobber.inWater = true;
        setState("waiting");
      }
    }

    if(state === "waiting"){
      bobber.y = (waterY + 52) + Math.sin(t/260)*1.2;
      if(t >= biteAt){
        setState("bite");
        log("â€¼ï¸ Bite! Tap Reel / double tap to hook.");
      }
    }

    if(state === "bite"){
      bobber.x += Math.sin(t/90)*0.7;
      bobber.y = (waterY + 52) + Math.sin(t/85)*2.7;
      if(t >= missAt){
        setState("miss");
        log("âŒ Missed it... too slow.");
      }
    }

    if(state === "fight" && hookedFish){
      const line = getLine();

      // fish pull varies
      fishPull = 0.35 + Math.sin(t/180)*0.20 + Math.random()*0.08;

      const rarPullMul = { common:1.0, uncommon:1.1, rare:1.25, epic:1.5, legendary:1.8 }[hookedFish.rarity] || 1.0;
      const kgFactor = clamp(hookedFish.kg / 12, 0.15, 2.2);
      const pull = fishPull * rarPullMul * kgFactor;

      if(holdingReel){
        tension += 0.010 * pull;
        fightEndAt -= 7.0;
      } else {
        tension -= 0.012;
      }

      tension += 0.004 * pull;
      tension = Math.max(0, tension);

      // Snap threshold scales with line strength
      const safe = 0.80 + (line.strengthKg/20)*0.30; // ~0.86 (4kg) .. ~1.10 (20kg)
      if(tension > safe){
        setState("snapped");
        hookedFish = null;
        holdingReel = false;
        log("ğŸ’¥ Line snapped! Buy a stronger line in the Shop.");
      }

      // win condition
      if(performance.now() >= fightEndAt && state==="fight"){
        const fish = hookedFish;
        hookedFish = null;
        holdingReel = false;

        const ok = addToKeepnet(fish);
        if(ok){
          log(`âœ… Landed fish! <b style="color:${rarColor(fish.rarity)}">${fish.name}</b><br>
               âš–ï¸ <b>${fmt2(fish.kg)}</b> kg Â· <b style="color:${rarColor(fish.rarity)}">${fish.rarity}</b>${fish.trophy ? " Â· <b style='color:#ffcc33'>TROPHY</b>" : ""}<br>
               ğŸ’ Stored in keepnet. Sell from Inventory anytime.`);
        }
        setState("ready");
        updateHud();
        saveNum("pf_money", money);
        saveNum("pf_netcap", keepnetCapKg);
      }

      // bobber reacts
      bobber.x += Math.sin(t/70)*0.6;
      bobber.y = (waterY + 52) + Math.sin(t/60)*2.0 + (holdingReel ? 0.6 : 0);
    }

    if(state === "miss" || state === "snapped"){
      bobber.y = (waterY + 52) + Math.sin(t/260)*1.1;
    }
  }

  function loop(t){
    update(t);
    drawScene(t);
    requestAnimationFrame(loop);
  }

  // ---------- Init ----------
  function saveAll(){
    saveNum("pf_money", money);
    saveNum("pf_netcap", keepnetCapKg);
  }

  updateDayBtn();
  setState("ready");
  updateHud();
  log("ğŸ£ Tap Cast or tap the water. When you see BITE: Reel/Hook. During Fight: hold Reel and watch tension.");

  window.addEventListener("beforeunload", saveAll);

  requestAnimationFrame(loop);
})();
</script>

<!-- Register Service Worker (PWA) -->
<script>
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js");
}
</script>

</body>
</html>
